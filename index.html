<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Simulateur - G√©othermie NIBE</title>
  <style>
    :root {
      --primary-color: #00695c;
      --secondary-color: #b71c1c;
      --accent-color: #2e7d32;
      --background-color: #f4f9f7;
      --surface-color: #ffffff;
      --text-color: #263238;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--background-color);
      color: var(--text-color);
      overscroll-behavior: none;
    }

    h1 {
      margin: 0;
      padding: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      background: var(--surface-color);
      color: var(--secondary-color);
      font-size: 1.3rem;
    }

    h1 span {
      display: inline-block;
      vertical-align: middle;
      font-weight: 600;
    }

    .app-container {
      max-width: 480px;
      margin: 0 auto;
      padding-bottom: 80px;
      position: relative;
    }

    .progress-bar-container {
      height: 6px;
      width: 100%;
      background: #e0e0e0;
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 1rem;
    }

    .progress-bar {
      height: 100%;
      width: 0%;
      background: var(--primary-color);
      transition: width 0.4s ease;
    }

    .step {
      display: none;
      animation: fadeIn 0.4s ease forwards;
    }

    .step.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .section-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      margin-top: 0;
      color: var(--secondary-color);
    }

    label {
      display: block;
      font-size: 0.9rem;
      margin-bottom: 0.3rem;
      font-weight: 500;
    }

    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      padding: 0.7rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 0.95rem;
      box-sizing: border-box;
      margin-bottom: 1rem;
    }

    input[type="checkbox"] {
      transform: scale(1.2);
      margin-right: 0.6rem;
    }

    .checkbox-group {
      margin-bottom: 1rem;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      background: var(--surface-color);
      padding: 0.6rem;
      margin-bottom: 0.4rem;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .checkbox-item input[type="checkbox"] {
      width: 1.3rem;
      height: 1.3rem;
      margin-right: 0.8rem;
      accent-color: var(--primary-color);
    }

    .next-btn, .prev-btn {
      display: inline-block;
      padding: 0.8rem 1.2rem;
      margin-top: 1rem;
      border: none;
      border-radius: 25px;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .next-btn {
      background: var(--primary-color);
      color: #fff;
    }

    .next-btn:hover {
      background: var(--accent-color);
    }

    .prev-btn {
      background: var(--secondary-color);
      color: #fff;
      margin-right: 1rem;
    }

    .prev-btn:hover {
      background: var(--primary-color);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
    }

    th, td {
      border-bottom: 1px solid #ddd;
      padding: 0.4rem 0.5rem;
      text-align: left;
      font-size: 0.9rem;
    }

    th {
      background: var(--primary-color);
      color: #fff;
      font-weight: 600;
    }

    .results-section {
      margin-top: 1rem;
    }

    .chart-container {
      width: 100%;
      height: 250px;
      margin-top: 1rem;
      position: relative;
      background: #f9fafb;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      padding: 0.5rem;
      box-sizing: border-box;
    }

    .chart-bars {
      position: relative;
      height: 100%;
      width: 100%;
      display: flex;
      align-items: flex-end;
      justify-content: space-around;
      padding: 0 1rem;
    }

    .chart-bar {
      flex: 1;
      margin: 0 0.3rem;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      align-items: center;
    }

    .chart-bar .bar {
      width: 80%;
      border-radius: 4px 4px 0 0;
      background: var(--primary-color);
      transition: height 0.5s ease;
      min-height: 4px;
    }

    .chart-bar .label {
      margin-top: 0.3rem;
      font-size: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: flex-start;
    }

    .print-btn {
      width: 100%;
      padding: 0.8rem;
      background: var(--secondary-color);
      color: #fff;
      border: none;
      border-radius: 25px;
      margin-top: 1.5rem;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .print-btn:hover {
      background: var(--primary-color);
    }

    .logo-img {
      width: 90px;
      height: auto;
      margin-right: 8px;
      vertical-align: middle;
    }

    .results-section p {
      margin: 0.4rem 0;
    }

    .highlight-prime {
      color: var(--accent-color);
      font-weight: 700;
      background: rgba(0, 191, 165, 0.15);
      padding: 2px 6px;
      border-radius: 4px;
      display: inline;
    }

    .highlight-plus {
      color: #2e7d32;
      font-weight: 700;
      background: rgba(46, 125, 50, 0.15);
      padding: 2px 6px;
      border-radius: 4px;
      display: inline;
    }

    .highlight-minus {
      color: #c62828;
      font-weight: 700;
      background: rgba(198, 40, 40, 0.15);
      padding: 2px 6px;
      border-radius: 4px;
      display: inline;
    }

    .highlight-charge {
      color: #2e7d32;
      font-weight: 700;
      background: rgba(46, 125, 50, 0.15);
      padding: 2px 6px;
      border-radius: 4px;
      display: inline;
    }

    .highlight-amort {
      background: #ffe0b2;
      color: var(--secondary-color);
      font-weight: 700;
      padding: 0 0.2rem;
      border-radius: 4px;
    }

    .metric {
      font-size: 0.9rem;
      font-weight: 600;
    }

    .bar {
      width: 80%;
      border-radius: 4px 4px 0 0;
      transition: height 0.5s ease;
    }

    .bar-default {
      background: var(--primary-color);
    }

    .bar-geothermie {
      background: var(--accent-color);
    }

    .chart-bar .bar-default {
      background: var(--primary-color) !important;
    }

    .chart-bar .bar-geothermie {
      background: var(--accent-color) !important;
    }

    #disclaimer {
      font-size: 0.75rem;
      line-height: 1.3;
      margin-top: 2rem;
      color: #444;
    }

    .chart-bars-horizontal {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      padding: 0.5rem;
    }

    .chart-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .row-label {
      flex-basis: 30%;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .row-bar {
      flex-grow: 1;
      height: 16px;
      background: #e0f7f4;
      border-radius: 8px;
      position: relative;
    }

    .row-fill {
      height: 100%;
      border-radius: 6px;
    }

    .row-fill-default {
      background: var(--primary-color);
    }

    .row-fill-geothermie {
      background: var(--accent-color);
    }

    .row-value {
      font-size: 0.8rem;
      min-width: 60px;
      text-align: right;
    }

    .vertical-chart {
      display: flex;
      justify-content: space-around;
      align-items: flex-end;
      height: 120px;
      width: 100%;
    }

    .vertical-column {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
      margin: 0 0.3rem;
      height: 100%;
    }

    .vertical-bar {
      width: 30px;
      border-radius: 4px 4px 0 0;
    }

    .vertical-value {
      font-size: 0.7rem;
      margin-bottom: 0.2rem;
    }

    .vertical-label {
      font-size: 0.7rem;
      text-align: center;
      margin-top: 0.3rem;
    }

    .energy-fields input {
      background: #ffffff;
    }

    .bar-value {
      font-size: 0.7rem;
      text-align: center;
      margin-bottom: 0.2rem;
    }

    @media print {
      @page {
        size: A4;
        margin: 8mm 8mm 10mm 8mm;
      }
      body {
        background: #fff;
        font-size: 8px;
        margin: 0;
        padding: 0;
      }
      .progress-bar-container,
      .prev-btn,
      .next-btn,
      .print-btn {
        display: none !important;
      }
      #step1, #step2, #step3, #step4, #step5, #step6 {
        display: none !important;
      }
      #step7 {
        display: block !important;
      }
      .app-container {
        max-width: none;
        margin: 0;
        padding: 0 10mm;
      }
      h1 {
        justify-content: flex-start !important;
        text-align: left !important;
        margin: 0 0 4mm 0;
        padding: 0;
        font-size: 14px;
      }
      .results-section h3 {
        font-size: 10px;
        margin: 2mm 0;
      }
      .results-section table th,
      .results-section table td {
        padding: 1mm 2mm;
        font-size: 8px;
      }
      .metric {
        font-size: 8px;
        margin: 1mm 0;
      }
      .chart-container {
        height: 90px;
        margin-top: 2mm;
        margin-bottom: 2mm;
      }
      .results-section,
      table,
      h1,
      #consumptionChart,
      #disclaimer {
        page-break-inside: avoid;
      }
      #disclaimer {
        display: block !important;
        position: static !important;
        font-size: 7px;
        margin-top: 3mm;
      }
      #pdfFooter {
        display: none !important;
      }
      html, body {
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      .logo-img {
        width: 70px;
        height: auto;
        margin-right: 6px;
      }
    }
  </style>
</head>
<body>
  <h1>
    <img class="logo-img" src="https://www.nibe.eu/images/18.6394f9d91836c36799c18b7/1716537072922/nibe-logo-web.svg" alt="NIBE logo" />
    <span>Simulateur&nbsp;‚Äî&nbsp;G√©othermie&nbsp;NIBE</span>
  </h1>

  <div class="app-container">
    <div class="progress-bar-container">
      <div id="progress" class="progress-bar" style="width: 0%;"></div>
    </div>

    <!-- √âtape 1 -->
    <div id="step1" class="step active">
      <p class="section-title">√âtape 1 : Conditions pr√©alables</p>
      <div class="checkbox-group">
        <div class="checkbox-item">
          <input type="checkbox" id="engagement" checked />
          <label for="engagement">
            Je confirme qu‚Äôil s‚Äôagit de ma r√©sidence principale en maison individuelle, que les travaux consistent en un remplacement d‚Äôune chaudi√®re gaz/fioul par une pompe √† chaleur g√©othermique NIBE, qu‚Äôils seront r√©alis√©s par une entreprise RGE et que le dossier sera d√©pos√© avant les travaux.
          </label>
        </div>
      </div>
      <label for="codePostal">Code&nbsp;postal</label>
      <input type="text" id="codePostal" placeholder="" maxlength="5" />
      <div style="text-align:right;">
        <button class="next-btn" onclick="nextStep(1)">Suivant ‚ñ∂</button>
      </div>
    </div>

    <!-- √âtape 2 -->
    <div id="step2" class="step">
      <p class="section-title">√âtape 2 : Tranche de revenu et surface</p>
      <label for="foyer">Nombre de personnes dans le foyer</label>
      <input type="number" id="foyer" placeholder="Ex : 3" min="1" oninput="updateRevenuRanges()" />
      <label for="revenuRange">Tranche de revenu fiscal de r√©f√©rence (‚Ç¨)</label>
      <select id="revenuRange">
        <option value="" disabled selected>Saisissez le nombre de personnes</option>
      </select>
      <label for="surface">Surface chauff√©e (m¬≤)</label>
      <input type="number" id="surface" placeholder="Ex : 100" min="1" />
      <div style="text-align:right;">
        <button class="prev-btn" onclick="prevStep(2)">‚óÄ Pr√©c√©dent</button>
        <button class="next-btn" onclick="nextStep(2)">Suivant ‚ñ∂</button>
      </div>
    </div>

    <!-- √âtape 3 -->
    <div id="step3" class="step">
      <p class="section-title">√âtape 3 : Type de pompe √† chaleur</p>
      <label for="typePac">Type de pompe √† chaleur</label>
      <select id="typePac">
        <option value="sol">Sol/Eau (g√©othermie)</option>
        <option value="eau">Eau/Eau (aquathermie)</option>
      </select>
      <label for="temperature">Temp√©rature de fonctionnement</label>
      <select id="temperature">
        <option value="35">35 ¬∞C</option>
        <option value="55" selected>55 ¬∞C radiateurs</option>
        <option value="55r">55 ¬∞C plancher chauffant + radiateurs</option>
      </select>
      <label for="usage">Usage</label>
      <select id="usage">
        <option value="chauffage">Chauffage seul</option>
        <option value="ecs" selected>Chauffage + Eau chaude sanitaire (ECS)</option>
      </select>
      <div style="text-align:right;">
        <button class="prev-btn" onclick="prevStep(3)">‚óÄ Pr√©c√©dent</button>
        <button class="next-btn" onclick="nextStep(3)">Suivant ‚ñ∂</button>
      </div>
    </div>

    <!-- √âtape 4 -->
    <div id="step4" class="step">
      <p class="section-title">√âtape 4 : S√©lection du mod√®le NIBE</p>
      <label for="modele">Mod√®le NIBE</label>
      <select id="modele"></select>
      <div style="text-align:right;">
        <button class="prev-btn" onclick="prevStep(4)">‚óÄ Pr√©c√©dent</button>
        <button class="next-btn" onclick="nextStep(4)">Suivant ‚ñ∂</button>
      </div>
    </div>

    <!-- √âtape 5 -->
    <div id="step5" class="step">
      <p class="section-title">
        √âtape 5 : Co√ªts d‚Äôinstallation
        <span id="travauxCibleInfo" style="font-size:0.85rem;font-weight:400;">
          (montant restant cible : <span id="travauxCibleValeur">-</span> ‚Ç¨)
        </span>
      </p>
      <label for="coutFourniture">Co√ªt fourniture PAC (‚Ç¨)</label>
      <input type="number" id="coutFourniture" placeholder="Ex&nbsp;: 15000" min="0" />
      <label for="coutMO">Co√ªt main d‚Äô≈ìuvre (‚Ç¨)</label>
      <input type="number" id="coutMO" placeholder="Ex&nbsp;: 2000" min="0" />
      <label for="coutForage">Co√ªt du capteur g√©othermique (sondes g√©othermiques/forage d'eau, aquathermie, main d‚Äô≈ìuvre) (‚Ç¨)</label>
      <input type="number" id="coutForage" placeholder="Ex&nbsp;: 7000" min="0" />
      <label for="coutChaudiere">Co√ªt du remplacement d‚Äôune chaudi√®re √©quivalente (‚Ç¨)</label>
      <input type="number" id="coutChaudiere" placeholder="Ex&nbsp;: 5000" min="0" />
      <div style="text-align:right;">
        <button class="prev-btn" onclick="prevStep(5)">‚óÄ Pr√©c√©dent</button>
        <button class="next-btn" onclick="nextStep(5)">Suivant ‚ñ∂</button>
      </div>
    </div>

    <!-- √âtape 6 -->
    <div id="step6" class="step">
      <p class="section-title">√âtape 6 : Param√®tres d‚Äôamortissement</p>
      <label for="energieType">√ânergie actuelle utilis√©e</label>
      <select id="energieType" onchange="updateEnergyFields()">
        <option value="fuel">Fioul</option>
        <option value="gaz">Gaz naturel</option>
        <option value="propane">Propane</option>
      </select>
      <div id="fuelFields" class="energy-fields">
        <label for="fuelLitres">Consommation annuelle (litres)</label>
        <input type="number" id="fuelLitres" placeholder="Ex : 2000" min="0" />
        <label for="fuelPrix">Prix du fioul (‚Ç¨ / litre)</label>
        <input type="number" id="fuelPrix" placeholder="Ex : 1,30" min="0" step="0.01" />
        <label for="fuelElecPrix">Prix du kWh √©lectrique (‚Ç¨)</label>
        <input type="number" id="fuelElecPrix" placeholder="Ex : 0,20" min="0" step="0.01" />
      </div>
      <div id="gazFields" class="energy-fields" style="display:none;">
        <label for="gazKwh">Consommation annuelle (kWh)</label>
        <input type="number" id="gazKwh" placeholder="Ex : 20000" min="0" />
        <label for="gazPrix">Prix du gaz (‚Ç¨ / kWh)</label>
        <input type="number" id="gazPrix" placeholder="Ex : 0,1284" min="0" step="0.0001" />
        <label for="gazAbonnement">Abonnement gaz (‚Ç¨ / an)</label>
        <input type="number" id="gazAbonnement" placeholder="Ex : 250" min="0" />
        <label for="gazElecPrix">Prix du kWh √©lectrique (‚Ç¨)</label>
        <input type="number" id="gazElecPrix" placeholder="Ex : 0,20" min="0" step="0.01" />
      </div>
      <div id="propaneFields" class="energy-fields" style="display:none;">
        <label for="propaneTonnes">Consommation annuelle (tonnes)</label>
        <input type="number" id="propaneTonnes" placeholder="Ex : 1,2" min="0" step="0.01" />
        <label for="propanePrix">Prix du propane (‚Ç¨ / tonne)</label>
        <input type="number" id="propanePrix" placeholder="Ex : 3353" min="0" />
        <label for="propaneAbonnement">Abonnement cuve (‚Ç¨ / an)</label>
        <input type="number" id="propaneAbonnement" placeholder="Ex : 250" min="0" />
        <label for="propaneElecPrix">Prix du kWh √©lectrique (‚Ç¨)</label>
        <input type="number" id="propaneElecPrix" placeholder="Ex : 0,20" min="0" step="0.01" />
      </div>
      <div style="text-align:right;">
        <button class="prev-btn" onclick="prevStep(6)">‚óÄ Pr√©c√©dent</button>
        <button class="next-btn" onclick="nextStep(6)">Suivant ‚ñ∂</button>
      </div>
    </div>

    <!-- √âtape 7 -->
    <div id="step7" class="step">
      <p class="section-title">√âtape 7 : R√©sultats de simulation</p>
      <div id="resultFinance" class="results-section"></div>
      <div id="resultAmort" class="results-section" style="margin-top: 1.5rem;"></div>
      <div id="consumptionChart" class="chart-container"></div>
      <div id="disclaimer" class="results-section" style="margin-top: 1rem; line-height:1.3;">
        <p><strong>Note :</strong> Cette simulation est fournie √† titre indicatif et n‚Äôa pas de valeur contractuelle. Les montants calcul√©s reposent sur les informations d√©clar√©es par l‚Äôutilisateur et des hypoth√®ses de co√ªts et de performances.</p>
        <p>Les aides financi√®res (prime CEE et MaPrimeR√©nov‚Äô) d√©pendent de la cat√©gorie de revenu, de la zone climatique, des justificatifs fournis et des validations des organismes comp√©tents (ANAH, d√©l√©gataire CEE). Les montants de cette simulation sont destin√©s aux professionnels, sont donn√©s √† titre indicatif et n‚Äôengagent pas NIBE France. Ces informations peuvent √™tre sujettes √† modifications ; la version actuelle est au <strong>1er octobre 2025</strong>. Les prix des CEE varient d‚Äôun oblig√© √† l‚Äôautre, donc les montants pr√©sent√©s sont des estimations et n‚Äôengagent pas la soci√©t√© NIBE.</p>
        <p>Le remplacement est √©tudi√© comme un monogeste (chaudi√®re gaz/fioul vers pompe √† chaleur g√©othermique NIBE). Les tarifs √©nerg√©tiques utilis√©s par d√©faut sont : gaz naturel 0,1284 ‚Ç¨/kWh, fioul 1,16 ‚Ç¨/L, propane 0,243 ‚Ç¨/kWh, √©lectricit√© 0,20 ‚Ç¨/kWh. Ces valeurs peuvent varier et doivent √™tre confirm√©es lors du projet.</p>
        <p>Le dossier de demande de subvention doit √™tre d√©pos√© avant le d√©but des travaux et l‚Äôinstallation doit √™tre r√©alis√©e par une entreprise certifi√©e RGE.</p>
      </div>
      <button class="print-btn" onclick="generatePdf()">üìÑ √âditer PDF</button>
      <div style="text-align:right;">
        <button class="prev-btn" onclick="prevStep(7)">‚óÄ Pr√©c√©dent</button>
      </div>
    </div>
  </div>

  <div id="pdfFooter" style="display:none; line-height:1.3;">
    <!-- optionnel -->
  </div>

  <script>
    const revenusBar√®me = {
      nonIDF: {
        tres: [17173, 25115, 30206, 35285, 40388],
        modeste: [22015, 32197, 38719, 45234, 51775],
        inter: [30844, 45340, 54592, 63844, 73098],
        supInc: { tres: 5094, modeste: 6525, inter: 9254 }
      },
      IDF: {
        tres: [23768, 34884, 41893, 48914, 55961],
        modeste: [28933, 42463, 51000, 59549, 68123],
        inter: [40404, 59394, 71060, 83637, 95758],
        supInc: { tres: 7038, modeste: 8568, inter: 12122 }
      }
    };

    const zoneH1 = [
      '01','02','03','05','08','10','14','15','19','21','23','25','27','28','38','39','42','43','45','51','52','54','55','57','58','59','60','61','62','63','67','68','69','70','71','73','74','75','76','77','78','80','87','88','89','90','91','92','93','94','95','975'
    ];
    const zoneH3 = [
      '06','11','13','20','2A','2B','30','34','66','83','971','972','973','974','976'
    ];

    const modelesData = {
      sol: {
        'NIBE S1156-8': { etas35: 200, etas55: 140 },
        'NIBE S1156-13': { etas35: 200, etas55: 140 },
        'NIBE S1156-18': { etas35: 230, etas55: 140 },
        'NIBE S1256-8': { etas35: 200, etas55: 140 },
        'NIBE S1256-13': { etas35: 200, etas55: 140 },
        'NIBE S1256-18': { etas35: 230, etas55: 140 },
        'NIBE F1253-4': { etas35: 200, etas55: 140 },
        'NIBE F1253-6': { etas35: 200, etas55: 140 },
        'NIBE F1153-4': { etas35: 200, etas55: 140 },
        'NIBE F1153-6': { etas35: 200, etas55: 140 },
        'NIBE S1155-25': { etas35: 200, etas55: 140 },
        'NIBE F1345-24': { etas35: 170, etas55: 140 },
        'NIBE F1345-40': { etas35: 170, etas55: 140 },
        'NIBE F1345-30': { etas35: 170, etas55: 111 },
        'NIBE F1345-60': { etas35: 170, etas55: 111 },
        'NIBE F1355-28': { etas35: 170, etas55: 140 },
        'NIBE F1355-43': { etas35: 170, etas55: 140 }
      },
      eau: {
        'NIBE S1156-8': { etas35: 230, etas55: 200 },
        'NIBE S1156-13': { etas35: 230, etas55: 230 },
        'NIBE S1156-18': { etas35: 230, etas55: 200 },
        'NIBE S1256-8': { etas35: 230, etas55: 200 },
        'NIBE S1256-13': { etas35: 230, etas55: 230 },
        'NIBE S1256-18': { etas35: 230, etas55: 200 },
        'NIBE F1253-4': { etas35: 230, etas55: 200 },
        'NIBE F1253-6': { etas35: 230, etas55: 200 },
        'NIBE F1153-4': { etas35: 230, etas55: 200 },
        'NIBE F1153-6': { etas35: 230, etas55: 200 },
        'NIBE S1155-25': { etas35: 230, etas55: 170 },
        'NIBE F1345-24': { etas35: 200, etas55: 170 },
        'NIBE F1345-40': { etas35: 200, etas55: 170 },
        'NIBE F1345-30': { etas35: 200, etas55: 140 },
        'NIBE F1345-60': { etas35: 200, etas55: 140 },
        'NIBE F1355-28': { etas35: 230, etas55: 170 },
        'NIBE F1355-43': { etas35: 230, etas55: 170 }
      }
    };

    const ceeLevelsChauffage = [88800, 102300, 111400, 117900, 120900];
    const ceeLevelsChauffageECS = [108100, 124600, 135600, 143500, 147200];

    let currentStep = 1;
    const totalSteps = 7;
    const state = {};

    function initModeleOptions() {
      const modeleSelect = document.getElementById('modele');
      modeleSelect.innerHTML = '';
      const type = document.getElementById('typePac').value;
      const models = modelesData[type];
      for (const model in models) {
        const opt = document.createElement('option');
        opt.value = model;
        opt.textContent = model;
        modeleSelect.appendChild(opt);
      }
      if (models['NIBE S1256-13']) {
        modeleSelect.value = 'NIBE S1256-13';
      }
    }

    function updateEnergyFields() {
      const type = document.getElementById('energieType').value;
      document.getElementById('fuelFields').style.display = 'none';
      document.getElementById('gazFields').style.display = 'none';
      document.getElementById('propaneFields').style.display = 'none';
      if (type === 'fuel') {
        document.getElementById('fuelFields').style.display = 'block';
      } else if (type === 'gaz') {
        document.getElementById('gazFields').style.display = 'block';
      } else if (type === 'propane') {
        document.getElementById('propaneFields').style.display = 'block';
      }
    }

    function determineCategorie(revenu, foyers, isIDF) {
      const bar = revenusBar√®me[isIDF ? 'IDF' : 'nonIDF'];
      const idx = Math.min(foyers, 5) - 1;
      function seuil(baseArr, incVal) {
        if (foyers <= 5) {
          return baseArr[idx];
        }
        const base = baseArr[4];
        const extra = foyers - 5;
        return base + extra * incVal;
      }
      const tRes = seuil(bar.tres, bar.supInc.tres);
      const mRes = seuil(bar.modeste, bar.supInc.modeste);
      const iRes = seuil(bar.inter, bar.supInc.inter);
      if (revenu <= tRes) return 'tres-modeste';
      if (revenu <= mRes) return 'modeste';
      if (revenu <= iRes) return 'intermediaire';
      return 'superieur';
    }

    function determineZone(codePostal) {
      let dep = codePostal.substring(0, 2);
      if (codePostal.startsWith('2A') || codePostal.startsWith('2B')) {
        dep = codePostal.substring(0, 2);
      }
      if (zoneH1.includes(dep)) return 'H1';
      if (zoneH3.includes(dep)) return 'H3';
      return 'H2';
    }

    function getEfficiencyLevel(etas) {
      if (etas >= 230) return 4;
      if (etas >= 200) return 3;
      if (etas >= 170) return 2;
      if (etas >= 140) return 1;
      if (etas >= 111) return 0;
      return 0;
    }

    function getSurfaceFactor(area) {
      const a = parseFloat(area);
      if (a < 70) return 0.5;
      if (a < 90) return 0.7;
      if (a < 110) return 1;
      if (a < 130) return 1.1;
      return 1.6;
    }

    function getZoneCoefficient(zone) {
      if (zone === 'H1') return 1.2;
      if (zone === 'H3') return 0.7;
      return 1;
    }

    function updateRevenuRanges() {
      const foyerInput = document.getElementById('foyer');
      const rangeSelect = document.getElementById('revenuRange');
      if (!rangeSelect || !foyerInput) return;
      const foyersVal = parseInt(foyerInput.value);
      const code = document.getElementById('codePostal') ? document.getElementById('codePostal').value.trim() : '';
      let dep = code.substring(0, 2);
      const idfDeps = ['75','77','78','91','92','93','94','95'];
      const isIDF = idfDeps.includes(dep);
      if (!foyersVal || isNaN(foyersVal) || foyersVal < 1) {
        rangeSelect.innerHTML = '';
        const opt = document.createElement('option');
        opt.disabled = true;
        opt.selected = true;
        opt.value = '';
        opt.textContent = 'Saisissez le nombre de personnes';
        rangeSelect.appendChild(opt);
        return;
      }
      const bar = revenusBar√®me[isIDF ? 'IDF' : 'nonIDF'];
      const idx = Math.min(foyersVal, 5) - 1;
      let tRes = bar.tres[idx];
      let mRes = bar.modeste[idx];
      let iRes = bar.inter[idx];
      if (foyersVal > 5) {
        const extra = foyersVal - 5;
        tRes += extra * bar.supInc.tres;
        mRes += extra * bar.supInc.modeste;
        iRes += extra * bar.supInc.inter;
      }
      function fmt(n) {
        return Math.round(n).toLocaleString('fr-FR');
      }
      rangeSelect.innerHTML = '';
      const defaultOpt = document.createElement('option');
      defaultOpt.disabled = true;
      defaultOpt.selected = true;
      defaultOpt.value = '';
      defaultOpt.textContent = 'S√©lectionnez votre tranche';
      rangeSelect.appendChild(defaultOpt);
      const opt0 = document.createElement('option');
      opt0.value = '0';
      opt0.textContent = '0 ‚Ç¨ ‚Äì ' + fmt(tRes) + ' ‚Ç¨';
      rangeSelect.appendChild(opt0);
      const opt1 = document.createElement('option');
      opt1.value = '1';
      const lower1 = tRes + 1;
      opt1.textContent = fmt(lower1) + ' ‚Ç¨ ‚Äì ' + fmt(mRes) + ' ‚Ç¨';
      rangeSelect.appendChild(opt1);
      const opt2 = document.createElement('option');
      opt2.value = '2';
      const lower2 = mRes + 1;
      opt2.textContent = fmt(lower2) + ' ‚Ç¨ ‚Äì ' + fmt(iRes) + ' ‚Ç¨';
      rangeSelect.appendChild(opt2);
      const opt3 = document.createElement('option');
      opt3.value = '3';
      const lower3 = iRes + 1;
      opt3.textContent = fmt(lower3) + ' ‚Ç¨ et plus';
      rangeSelect.appendChild(opt3);
    }

    function calculAides() {
      const type = state.typePac;
      const mode = state.modele;
      const temp = state.temperature;
      const usage = state.usage;
      const surface = parseFloat(state.surface);
      const revenu = parseFloat(state.revenu);
      const foyers = parseInt(state.foyer);
      const isIDF = state.isIDF;
      const zone = state.zoneClim;
      const etasData = modelesData[type][mode];
      let etas;
      if (temp.startsWith('35')) {
        etas = etasData.etas35;
      } else {
        etas = etasData.etas55;
      }
      const level = getEfficiencyLevel(etas);
      let baseKwh = (usage === 'ecs') ? ceeLevelsChauffageECS[level] : ceeLevelsChauffage[level];
      const surfFactor = getSurfaceFactor(surface);
      const zoneCoef = getZoneCoefficient(zone);
      const kwhCumac = baseKwh * surfFactor * zoneCoef * 5;
      const mwhCumac = kwhCumac / 1000;
      let categorie;
      if (state.categorie) {
        categorie = state.categorie;
      } else {
        categorie = determineCategorie(revenu, foyers, isIDF);
      }
      let tarifMwh;
      if (categorie === 'tres-modeste') {
        tarifMwh = 8.26;
      } else if (categorie === 'modeste' || categorie === 'intermediaire') {
        tarifMwh = 7.02;
      } else {
        tarifMwh = 0;
      }
      const primeCEE = mwhCumac * tarifMwh;
      let primeMPR;
      if (categorie === 'tres-modeste') primeMPR = 11000;
      else if (categorie === 'modeste') primeMPR = 9000;
      else if (categorie === 'intermediaire') primeMPR = 6000;
      else primeMPR = 0;
      return { categorie, primeCEE, primeMPR, mwhCumac, kwhCumac };
    }

    // MONTANT RESTANT CIBLE
    function updateTravauxCible() {
      const spanVal = document.getElementById('travauxCibleValeur');
      if (!spanVal) return;
      try {
        const aides = calculAides();
        const primeCEE = aides.primeCEE || 0;
        const primeMPR = aides.primeMPR || 0;
        const totalPrimes = primeCEE + primeMPR;

        if (totalPrimes > 0) {
          const cibleTotal = totalPrimes / 0.75;

          const coutFourniture = parseFloat(document.getElementById('coutFourniture').value) || 0;
          const coutMO = parseFloat(document.getElementById('coutMO').value) || 0;
          const coutForage = parseFloat(document.getElementById('coutForage').value) || 0;

          const dejaSaisi = coutFourniture + coutMO + coutForage;
          const restant = cibleTotal - dejaSaisi;

          spanVal.textContent = restant.toLocaleString('fr-FR', {
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
          });
        } else {
          spanVal.textContent = '-';
        }
      } catch (e) {
        spanVal.textContent = '-';
      }
    }

    function calculFinance() {
      const aides = calculAides();
      const coutFourniture = parseFloat(state.coutFourniture);
      const coutMO = parseFloat(state.coutMO);
      const coutForage = parseFloat(state.coutForage);
      const invest = coutFourniture + coutMO + coutForage;

      const primeCEE = aides.primeCEE;
      const primeMPRBrut = aides.primeMPR;
      const maxAides = 0.75 * invest;
      let primeMPR = primeMPRBrut;

      if (primeCEE + primeMPRBrut > maxAides) {
        primeMPR = Math.max(0, maxAides - primeCEE);
      }

      const primeTot = primeCEE + primeMPR;
      const resteCharge = invest - primeTot;
      const coutChaudiere = parseFloat(state.coutChaudiere);
      const plusValue = resteCharge - coutChaudiere;

      return {
        invest,
        primeCEE,
        primeMPR,
        primeTot,
        resteCharge,
        plusValue,
        categorie: aides.categorie,
        mwhCumac: aides.mwhCumac
      };
    }

    function calculAmortissement() {
      const type = state.energieType;
      let thermalEnergy;
      let coutEnergy;
      let costDetails = {};
      const defaultFuelPrice = 1.16;
      const defaultGazPrice = 0.1284;
      const defaultGazAbonnement = 250;
      const defaultPropanePrice = 3353.4;
      const defaultPropaneAbonnement = 250;
      const defaultElecPrice = 0.20;
      let cop = 5;
      if (state.temperature && state.temperature.startsWith('35')) {
        cop = 6.5;
      }
      if (type === 'fuel') {
        const litres = parseFloat(state.fuelLitres);
        const prixLitre = parseFloat(state.fuelPrix);
        const prixElec = parseFloat(state.fuelElecPrix);
        thermalEnergy = litres * 10;
        coutEnergy = litres * prixLitre;
        costDetails.fuel = { consommation: litres, cout: coutEnergy, unit: 'L', prixUnit: prixLitre };
        const gazCons = thermalEnergy;
        const gazCost = gazCons * defaultGazPrice + defaultGazAbonnement;
        costDetails.gaz = { consommation: gazCons, cout: gazCost, unit: 'kWh', prixUnit: defaultGazPrice, abonnement: defaultGazAbonnement };
        const propaneConsTon = thermalEnergy / (13.8 * 1000);
        const propaneCost = propaneConsTon * defaultPropanePrice + defaultPropaneAbonnement;
        costDetails.propane = { consommation: propaneConsTon, cout: propaneCost, unit: 't', prixUnit: defaultPropanePrice, abonnement: defaultPropaneAbonnement };
        const geothKwh = thermalEnergy / cop;
        const geothCost = geothKwh * prixElec;
        costDetails.geothermie = { consommation: geothKwh, cout: geothCost, unit: 'kWh', prixUnit: prixElec };
      } else if (type === 'gaz') {
        const kwhGaz = parseFloat(state.gazKwh);
        const prixGaz = parseFloat(state.gazPrix);
        const aboGaz = parseFloat(state.gazAbonnement);
        const prixElec = parseFloat(state.gazElecPrix);
        thermalEnergy = kwhGaz;
        coutEnergy = kwhGaz * prixGaz + aboGaz;
        costDetails.gaz = { consommation: kwhGaz, cout: coutEnergy, unit: 'kWh', prixUnit: prixGaz, abonnement: aboGaz };
        const fuelLitres = thermalEnergy / 10;
        const fuelCost = fuelLitres * defaultFuelPrice;
        costDetails.fuel = { consommation: fuelLitres, cout: fuelCost, unit: 'L', prixUnit: defaultFuelPrice };
        const propaneConsTon = thermalEnergy / (13.8 * 1000);
        const propaneCost = propaneConsTon * defaultPropanePrice + defaultPropaneAbonnement;
        costDetails.propane = { consommation: propaneConsTon, cout: propaneCost, unit: 't', prixUnit: defaultPropanePrice, abonnement: defaultPropaneAbonnement };
        const geothKwh = thermalEnergy / cop;
        const geothCost = geothKwh * prixElec;
        costDetails.geothermie = { consommation: geothKwh, cout: geothCost, unit: 'kWh', prixUnit: prixElec };
      } else if (type === 'propane') {
        const tonnes = parseFloat(state.propaneTonnes);
        const prixT = parseFloat(state.propanePrix);
        const aboP = parseFloat(state.propaneAbonnement);
        const prixElec = parseFloat(state.propaneElecPrix);
        thermalEnergy = tonnes * 1000 * 13.8;
        coutEnergy = tonnes * prixT + aboP;
        costDetails.propane = { consommation: tonnes, cout: coutEnergy, unit: 't', prixUnit: prixT, abonnement: aboP };
        const fuelLitres = thermalEnergy / 10;
        const fuelCost = fuelLitres * defaultFuelPrice;
        costDetails.fuel = { consommation: fuelLitres, cout: fuelCost, unit: 'L', prixUnit: defaultFuelPrice };
        const gazCons = thermalEnergy;
        const gazCost = gazCons * defaultGazPrice + defaultGazAbonnement;
        costDetails.gaz = { consommation: gazCons, cout: gazCost, unit: 'kWh', prixUnit: defaultGazPrice, abonnement: defaultGazAbonnement };
        const geothKwh = thermalEnergy / cop;
        const geothCost = geothKwh * prixElec;
        costDetails.geothermie = { consommation: geothKwh, cout: geothCost, unit: 'kWh', prixUnit: prixElec };
      }
      const emissionFactors = { fuel: 0.314, gaz: 0.243, propane: 0.27, electric: 0.053 };
      let emissionsOld = 0;
      let emissionsGeo = 0;
      let emissionsSaved = 0;
      if (type === 'fuel' || type === 'gaz' || type === 'propane') {
        emissionsOld = thermalEnergy * emissionFactors[type];
        const geothKwh = costDetails.geothermie ? costDetails.geothermie.consommation : thermalEnergy / cop;
        emissionsGeo = geothKwh * emissionFactors.electric;
        emissionsSaved = emissionsOld - emissionsGeo;
      }
      return { thermalEnergy, coutEnergy, costDetails, emissionsOld, emissionsGeo, emissionsSaved };
    }

    function updateProgress() {
      const percent = (currentStep - 1) / (totalSteps - 1) * 100;
      document.getElementById('progress').style.width = percent + '%';
    }

    function nextStep(step) {
      if (!validateStep(step)) return;
      document.getElementById(`step${step}`).classList.remove('active');
      currentStep = Math.min(totalSteps, step + 1);
      document.getElementById(`step${currentStep}`).classList.add('active');
      updateProgress();
      if (currentStep === 4) {
        initModeleOptions();
      }
      if (currentStep === 5) {
        updateTravauxCible();
      }
      if (currentStep === 7) {
        afficherResultats();
      }
      if (currentStep === 2) {
        updateRevenuRanges();
      }
    }

    function prevStep(step) {
      document.getElementById(`step${step}`).classList.remove('active');
      currentStep = Math.max(1, step - 1);
      document.getElementById(`step${currentStep}`).classList.add('active');
      updateProgress();
    }

    function validateStep(step) {
      if (step === 1) {
        if (!document.getElementById('engagement').checked) {
          alert('Veuillez confirmer que vous remplissez les conditions pr√©alables.');
          return false;
        }
        const code = document.getElementById('codePostal').value.trim();
        if (!code || code.length < 2) {
          alert('Veuillez saisir un code postal valide.');
          return false;
        }
        const dep = code.substring(0, 2);
        const idfDeps = ['75','77','78','91','92','93','94','95'];
        const isIDF = idfDeps.includes(dep);
        const zone = determineZone(code);
        state.codePostal = code;
        state.isIDF = isIDF;
        state.zoneClim = zone;
      } else if (step === 2) {
        const rangeVal = document.getElementById('revenuRange').value;
        const foyersVal = parseInt(document.getElementById('foyer').value);
        const surfaceVal = parseFloat(document.getElementById('surface').value);
        if (!rangeVal || isNaN(foyersVal) || isNaN(surfaceVal)) {
          alert('Veuillez s√©lectionner votre tranche de revenu, saisir le nombre de personnes et la surface chauff√©e.');
          return false;
        }
        const rangeIndex = parseInt(rangeVal);
        const catMap = ['tres-modeste', 'modeste', 'intermediaire', 'superieur'];
        state.categorie = catMap[rangeIndex] || 'superieur';
        state.foyer = foyersVal;
        state.surface = surfaceVal;
        state.revenu = 0;
      } else if (step === 3) {
        const type = document.getElementById('typePac').value;
        const temp = document.getElementById('temperature').value;
        const usage = document.getElementById('usage').value;
        state.typePac = type;
        state.temperature = temp;
        state.usage = usage;
      } else if (step === 4) {
        const modele = document.getElementById('modele').value;
        state.modele = modele;
      } else if (step === 5) {
        let coutFourniture = parseFloat(document.getElementById('coutFourniture').value);
        let coutMO = parseFloat(document.getElementById('coutMO').value);
        let coutForage = parseFloat(document.getElementById('coutForage').value);
        let coutChaudiere = parseFloat(document.getElementById('coutChaudiere').value);
        coutFourniture = isNaN(coutFourniture) ? 0 : coutFourniture;
        coutMO = isNaN(coutMO) ? 0 : coutMO;
        coutForage = isNaN(coutForage) ? 0 : coutForage;
        coutChaudiere = isNaN(coutChaudiere) ? 0 : coutChaudiere;
        state.coutFourniture = coutFourniture;
        state.coutMO = coutMO;
        state.coutForage = coutForage;
        state.coutChaudiere = coutChaudiere;
      } else if (step === 6) {
        const type = document.getElementById('energieType').value;
        state.energieType = type;
        if (type === 'fuel') {
          let litres = parseFloat(document.getElementById('fuelLitres').value.replace(',', '.'));
          let prix = parseFloat(document.getElementById('fuelPrix').value.replace(',', '.'));
          let prixElec = parseFloat(document.getElementById('fuelElecPrix').value.replace(',', '.'));
          litres = isNaN(litres) ? 2000 : litres;
          prix = isNaN(prix) ? 1.16 : prix;
          prixElec = isNaN(prixElec) ? 0.20 : prixElec;
          state.fuelLitres = litres;
          state.fuelPrix = prix;
          state.fuelElecPrix = prixElec;
        } else if (type === 'gaz') {
          let kwh = parseFloat(document.getElementById('gazKwh').value.replace(',', '.'));
          let prix = parseFloat(document.getElementById('gazPrix').value.replace(',', '.'));
          let abo = parseFloat(document.getElementById('gazAbonnement').value.replace(',', '.'));
          let prixElec = parseFloat(document.getElementById('gazElecPrix').value.replace(',', '.'));
          kwh = isNaN(kwh) ? 20000 : kwh;
          prix = isNaN(prix) ? 0.1284 : prix;
          abo = isNaN(abo) ? 250 : abo;
          prixElec = isNaN(prixElec) ? 0.20 : prixElec;
          state.gazKwh = kwh;
          state.gazPrix = prix;
          state.gazAbonnement = abo;
          state.gazElecPrix = prixElec;
        } else if (type === 'propane') {
          let tonnes = parseFloat(document.getElementById('propaneTonnes').value.replace(',', '.'));
          let prixT = parseFloat(document.getElementById('propanePrix').value.replace(',', '.'));
          let abo = parseFloat(document.getElementById('propaneAbonnement').value.replace(',', '.'));
          let prixElec = parseFloat(document.getElementById('propaneElecPrix').value.replace(',', '.'));
          tonnes = isNaN(tonnes) ? 1.2 : tonnes;
          prixT = isNaN(prixT) ? 3353.4 : prixT;
          abo = isNaN(abo) ? 250 : abo;
          prixElec = isNaN(prixElec) ? 0.20 : prixElec;
          state.propaneTonnes = tonnes;
          state.propanePrix = prixT;
          state.propaneAbonnement = abo;
          state.propaneElecPrix = prixElec;
        }
      }
      return true;
    }

    function afficherResultats() {
      const finance = calculFinance();
      const amort = calculAmortissement();
      const finDiv = document.getElementById('resultFinance');
      finDiv.innerHTML = '';
      let html = '<h3>R√©sultats de simulation</h3>';
      html += '<table><tr><th>√âl√©ment</th><th>Montant (‚Ç¨)</th></tr>';
      html += `<tr><td>Co√ªt fourniture PAC</td><td>${state.coutFourniture.toFixed(2)}</td></tr>`;
      html += `<tr><td>Co√ªt main d‚Äô≈ìuvre</td><td>${state.coutMO.toFixed(2)}</td></tr>`;
      html += `<tr><td>Co√ªt capteur g√©othermique</td><td>${state.coutForage.toFixed(2)}</td></tr>`;
      html += `<tr><td>Investissement total</td><td>${finance.invest.toFixed(2)}</td></tr>`;
      html += `<tr><td>Prime CEE</td><td>${finance.primeCEE.toFixed(2)}</td></tr>`;
      html += `<tr><td>MaPrimeR√©nov‚Äô</td><td>${finance.primeMPR.toFixed(2)}</td></tr>`;
      html += `<tr><td>Total des primes</td><td><span class="highlight-prime">${finance.primeTot.toFixed(2)}</span></td></tr>`;
      html += `<tr><td>Reste √† charge</td><td><span class="highlight-charge">${finance.resteCharge.toFixed(2)}</span></td></tr>`;
      html += `<tr><td>Co√ªt remplacement chaudi√®re √©quivalente</td><td>${state.coutChaudiere.toFixed(2)}</td></tr>`;
      const pvClass = finance.plusValue >= 0 ? 'highlight-plus' : 'highlight-minus';
      html += `<tr><td>Diff√©rence (g√©othermie ‚Äì remplacement)</td><td><span class="${pvClass}">${finance.plusValue.toFixed(2)}</span></td></tr>`;
      html += '</table>';
      html += `<p class="metric">Cat√©gorie de revenu : <strong>${finance.categorie}</strong></p>`;
      const zoneGeo = state.isIDF ? '√éle-de-France' : 'Hors √éle-de-France';
      html += `<p class="metric">Zone g√©ographique : <strong>${zoneGeo}</strong></p>`;
      html += `<p class="metric">Zone climatique : <strong>${state.zoneClim}</strong> (facteur zone ${getZoneCoefficient(state.zoneClim)})</p>`;
      html += `<p class="metric">Surface chauff√©e : <strong>${state.surface} m¬≤</strong> (facteur surface ${getSurfaceFactor(state.surface)})</p>`;
      const kwhCumac = finance.mwhCumac * 1000;
      html += `<p class="metric">√ânergie cumul√©e CEE : <strong>${kwhCumac.toFixed(0)}</strong> kWh cumac (${finance.mwhCumac.toFixed(2)} MWh)</p>`;
      finDiv.innerHTML = html;

      const amortDiv = document.getElementById('resultAmort');
      amortDiv.innerHTML = '';
      let h = '<h3>Amortissement et consommation</h3>';
      h += '<table><tr><th>√ânergie</th><th>Consommation</th><th>Co√ªt annuel (‚Ç¨)</th></tr>';
      const c = amort.costDetails;
      function formatCons(val, unit) {
        if (unit === 'kWh' || unit === 'kWh√©lec' || unit === 'kWhe') {
          return val.toFixed(0) + ' kWh';
        }
        return val.toFixed(2) + ' ' + unit;
      }
      const selected = state.energieType;
      if (selected === 'fuel' && c.fuel) {
        h += `<tr><td>Fioul</td><td>${formatCons(c.fuel.consommation, c.fuel.unit)}</td><td>${c.fuel.cout.toFixed(2)}</td></tr>`;
      }
      if (selected === 'gaz' && c.gaz) {
        h += `<tr><td>Gaz naturel</td><td>${formatCons(c.gaz.consommation, c.gaz.unit)}</td><td>${c.gaz.cout.toFixed(2)}</td></tr>`;
      }
      if (selected === 'propane' && c.propane) {
        h += `<tr><td>Propane</td><td>${formatCons(c.propane.consommation, c.propane.unit)}</td><td>${c.propane.cout.toFixed(2)}</td></tr>`;
      }
      if (c.geothermie) {
        h += `<tr><td>G√©othermie</td><td>${formatCons(c.geothermie.consommation, c.geothermie.unit)}</td><td>${c.geothermie.cout.toFixed(2)}</td></tr>`;
      }
      h += '</table>';
      const coutActuel = amort.coutEnergy;
      const coutGeo = c.geothermie ? c.geothermie.cout : 0;
      const economie = coutActuel - coutGeo;
      const plusVal = finance.plusValue;
      let amorti = '‚àû';
      if (economie > 0) {
        const years = plusVal / economie;
        amorti = years > 0 ? years.toFixed(1) : '0';
      }
      h += `<p class="metric">Co√ªt annuel actuel : <strong>${coutActuel.toFixed(2)}</strong> ‚Ç¨</p>`;
      h += `<p class="metric">Co√ªt annuel avec g√©othermie : <strong>${coutGeo.toFixed(2)}</strong> ‚Ç¨</p>`;
      h += `<p class="metric">√âconomie annuelle estim√©e : <strong>${economie.toFixed(2)}</strong> ‚Ç¨</p>`;
      h += `<p class="metric">Amortissement estim√© (ann√©es) : <span class="highlight-amort">${amorti}</span></p>`;
      if (amort.emissionsSaved && amort.emissionsSaved > 0) {
        h += `<p class="metric">√âmissions √©vit√©es : <strong>${amort.emissionsSaved.toFixed(0)}</strong> kg CO‚ÇÇ/an</p>`;
      }
      amortDiv.innerHTML = h;

      const barLabels = [];
      const barValues = [];
      const cDetails = amort.costDetails;
      if (cDetails.geothermie) {
        barLabels.push('G√©othermie');
        barValues.push(cDetails.geothermie.cout);
      }
      barLabels.push('Fioul');
      barValues.push(cDetails.fuel ? cDetails.fuel.cout : 0);
      barLabels.push('Gaz naturel');
      barValues.push(cDetails.gaz ? cDetails.gaz.cout : 0);
      barLabels.push('Propane');
      barValues.push(cDetails.propane ? cDetails.propane.cout : 0);
      drawSVGColumnChart('consumptionChart', barLabels, barValues);
    }

    function drawSVGColumnChart(containerId, labels, values) {
      const container = document.getElementById(containerId);
      if (!container) return;
      container.innerHTML = '';
      const maxVal = Math.max(...values);
      const svgWidth = container.clientWidth || 400;
      const svgHeight = 200;
      const paddingTop = 20;
      const paddingBottom = 40;
      const barAreaHeight = svgHeight - paddingTop - paddingBottom;
      const barWidth = svgWidth / labels.length * 0.5;
      const barGap = (svgWidth / labels.length - barWidth);
      const svgNS = 'http://www.w3.org/2000/svg';
      const svg = document.createElementNS(svgNS, 'svg');
      svg.setAttribute('width', '100%');
      svg.setAttribute('height', svgHeight);
      const border = document.createElementNS(svgNS, 'rect');
      border.setAttribute('x', 0);
      border.setAttribute('y', 0);
      border.setAttribute('width', '100%');
      border.setAttribute('height', svgHeight);
      border.setAttribute('fill', 'none');
      border.setAttribute('stroke', '#cccccc');
      border.setAttribute('stroke-width', '1');
      svg.appendChild(border);
      const baseline = document.createElementNS(svgNS, 'line');
      baseline.setAttribute('x1', 0);
      baseline.setAttribute('y1', paddingTop + barAreaHeight);
      baseline.setAttribute('x2', svgWidth);
      baseline.setAttribute('y2', paddingTop + barAreaHeight);
      baseline.setAttribute('stroke', '#cccccc');
      baseline.setAttribute('stroke-width', '1');
      svg.appendChild(baseline);
      labels.forEach((label, idx) => {
        const x = barGap / 2 + idx * (barWidth + barGap);
        const barHeight = maxVal > 0 ? (values[idx] / maxVal) * barAreaHeight : 0;
        const y = paddingTop + (barAreaHeight - barHeight);
        let color;
        const lower = label.toLowerCase();
        if (lower.includes('fioul')) {
          color = '#fb8c00';
        } else if (lower.includes('gaz')) {
          color = '#8e24aa';
        } else if (lower.includes('propane')) {
          color = '#e53935';
        } else if (lower.includes('g√©othermie') || lower.includes('geothermie')) {
          color = '#00695c';
        } else {
          color = '#00897b';
        }
        const rect = document.createElementNS(svgNS, 'rect');
        rect.setAttribute('x', x);
        rect.setAttribute('y', y);
        rect.setAttribute('width', barWidth);
        rect.setAttribute('height', barHeight);
        rect.setAttribute('fill', color);
        svg.appendChild(rect);
        const valueText = document.createElementNS(svgNS, 'text');
        valueText.setAttribute('x', x + barWidth / 2);
        valueText.setAttribute('y', y - 5);
        valueText.setAttribute('text-anchor', 'middle');
        valueText.setAttribute('font-size', '10');
        valueText.textContent = Math.round(values[idx]).toLocaleString() + ' ‚Ç¨';
        svg.appendChild(valueText);
        const labelText = document.createElementNS(svgNS, 'text');
        labelText.setAttribute('x', x + barWidth / 2);
        labelText.setAttribute('y', svgHeight - paddingBottom + 15);
        labelText.setAttribute('text-anchor', 'middle');
        labelText.setAttribute('font-size', '10');
        labelText.textContent = label;
        svg.appendChild(labelText);
      });
      container.appendChild(svg);
    }

    function generatePdf() {
      if (typeof afficherResultats === 'function') {
        afficherResultats();
      }

      var fin = document.getElementById('resultFinance').innerHTML || '';
      var amort = document.getElementById('resultAmort').innerHTML || '';
      var chart = document.getElementById('consumptionChart').innerHTML || '';
      var disclaimer = document.getElementById('disclaimer').innerHTML || '';

      var w = window.open('', '_blank');
      if (!w) return;

      var doc = w.document;
      doc.open();
      doc.write(
        '<!DOCTYPE html>' +
        '<html lang="fr">' +
        '<head>' +
        '<meta charset="UTF-8">' +
        '<title>Simulation g√©othermie NIBE</title>' +
        '<style>' +
        '@page { size: A4; margin: 10mm; }' +
        'body { font-family: "Inter", Arial, sans-serif; font-size: 11px; line-height:1.35; margin:0; }' +
        'h1 { display:flex; align-items:center; font-size:16px; margin:0 0 10px 0; }' +
        '.logo-img { width:70px; height:auto; margin-right:8px; }' +
        'h3 { font-size:13px; margin:6px 0; }' +
        '.section-title { font-size:12px; margin:6px 0; color:#b71c1c; font-weight:600; }' +
        'table { width:100%; border-collapse:collapse; font-size:9px; }' +
        'th, td { border:1px solid #ccc; padding:2px 3px; }' +
        '.metric { font-size:10px; margin:3px 0; }' +
        '#disclaimer { font-size:8px; margin-top:10px; }' +
        '.chart-container { margin-top:8px; }' +
        '.highlight-prime { color:#2e7d32; font-weight:700; background:rgba(0,191,165,0.15); padding:1px 3px; border-radius:3px; }' +
        '.highlight-charge { color:#2e7d32; font-weight:700; background:rgba(46,125,50,0.15); padding:1px 3px; border-radius:3px; }' +
        '.highlight-plus { color:#2e7d32; font-weight:700; background:rgba(46,125,50,0.15); padding:1px 3px; border-radius:3px; }' +
        '.highlight-minus { color:#c62828; font-weight:700; background:rgba(198,40,40,0.15); padding:1px 3px; border-radius:3px; }' +
        '.highlight-amort { background:#ffe0b2; color:#b71c1c; font-weight:700; padding:1px 4px; border-radius:3px; }' +
        '@media print { html, body { -webkit-print-color-adjust: exact; print-color-adjust: exact; } }' +
        '</style>' +
        '</head>' +
        '<body>' +
        '<h1><img class="logo-img" src="https://www.nibe.eu/images/18.6394f9d91836c36799c18b7/1716537072922/nibe-logo-web.svg" alt="NIBE logo"><span>Simulateur&nbsp;‚Äî&nbsp;G√©othermie&nbsp;NIBE</span></h1>' +
        fin +
        amort +
        '<div class="chart-container">' + chart + '</div>' +
        '<div id="disclaimer">' + disclaimer + '</div>' +
        '</body>' +
        '</html>'
      );
      doc.close();
      w.focus();
      w.print();
    }

    document.addEventListener('DOMContentLoaded', () => {
      initModeleOptions();
      updateEnergyFields();
      updateProgress();

      ['coutFourniture','coutMO','coutForage'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.addEventListener('input', updateTravauxCible);
        }
      });
    });
  </script>
</body>
</html>
