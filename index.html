<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Simulateur — PAC géothermique NIBE</title>
<style>
  :root{--bg:#f7fafc;--panel:#fff;--ink:#0f172a;--muted:#64748b;--line:#e5e7eb;--primary:#c20f0f;--good:#059669;--warn:#b45309;--shadow:0 10px 30px rgba(2,8,23,.08)}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial}

  .topbar{position:sticky;top:0;z-index:40;background:#fff;border-bottom:1px solid var(--line)}
  .topbar-inner{max-width:1100px;margin:0 auto;padding:10px 16px;display:flex;align-items:center;gap:14px}
  .brand h1{margin:0;font-size:clamp(1.1rem,1rem + .8vw,1.6rem);font-weight:800}

  .wrap{max-width:1100px;margin:22px auto;padding:0 16px 80px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:18px;box-shadow:var(--shadow);margin:16px 0}
  h2{margin:0 0 10px;font-size:1.15rem}
  label{font-weight:650}
  input,select{width:100%;padding:10px 12px;border:1px solid #cbd5e1;border-radius:12px;background:#fff}
  input:focus,select:focus{outline:none;box-shadow:0 0 0 3px rgba(194,15,15,.18);border-color:#f5b3b3}
  .row{display:flex;gap:14px;flex-wrap:wrap}
  .half{flex:1 1 320px}
  .muted{color:#64748b}

  .actions{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
  .btn{border:1px solid #cbd5e1;background:#fff;color:var(--ink);border-radius:12px;padding:10px 16px;font-weight:800;cursor:pointer;box-shadow:0 4px 14px rgba(2,8,23,.06)}
  .btn:hover{box-shadow:0 8px 18px rgba(2,8,23,.12)}
  .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
  .btn.ghost{background:transparent}
  .btn:disabled{opacity:.6;cursor:not-allowed}

  .wizard-head{display:flex;align-items:center;gap:12px;margin:8px 0}
  .step-title{font-weight:800}
  .progressbar{position:relative;flex:1;height:8px;background:#e5e7eb;border-radius:999px;overflow:hidden}
  .progressbar .bar{position:absolute;left:0;top:0;bottom:0;width:0;background:var(--primary);transition:width .35s ease}
  .progress-info{min-width:110px;text-align:right;color:#475569;font-weight:700}
  .step{display:none;opacity:0;transform:translateY(10px);transition:opacity .35s ease,transform .35s ease}
  .step.active{display:block;opacity:1;transform:translateY(0)}

  .choices{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px}
  .choice{display:flex;align-items:center;gap:12px;border:1px solid #d1d5db;border-radius:14px;padding:12px;cursor:pointer;background:#fff}
  .choice:hover{box-shadow:0 8px 18px rgba(2,8,23,.12)}
  .choice input{margin:0}
  .choice .lbl{font-weight:700}

  .checklist{display:grid;gap:10px}
  .check{display:flex;align-items:flex-start;gap:10px}
  .check input[type=checkbox]{width:18px;height:18px;accent-color:var(--primary);margin:2px 0 0 0}
  .check .txt{line-height:1.35}

  /* Live */
  #live{display:none}
  .kpi{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
  .tile{border:1px solid #e5e7eb;border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:6px}
  .tile .lab{font-size:.92rem;color:#475569}
  .tile .val{font-size:1.2rem;font-weight:900;text-align:right;font-variant-numeric:tabular-nums}
  .tile.aides{background:#eef2ff;border-color:#c7d2fe}
  .tile.aides .val{color:#1d4ed8}
  .pv-green{color:var(--good);font-weight:800}
  .warn{background:#fff7ed;border:1px solid #fed7aa;color:#b45309;border-radius:12px;padding:10px 12px}
  table{width:100%;border-collapse:collapse;background:#fff;border:1px solid #e5e7eb;border-radius:10px;overflow:hidden}
  th,td{border-bottom:1px solid #e5e7eb;padding:6px 8px;text-align:left}
  td.right{text-align:right;font-variant-numeric:tabular-nums}

  /* ===== Impression A4 compacte ===== */
  @page{ size:A4; margin:10mm } /* avant 14mm */

  #rapport-letter .a4{width:210mm;min-height:297mm;background:#fff;color:#111827;padding:12mm 14mm;border:1px solid #e5e7eb;margin:auto}

  /* Préservation des couleurs à l'impression */
  @media print{
    *{ -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important }
    .no-print{display:none!important}
    #rapport-letter{display:block}
    .a4{border:0}
    .page-break{page-break-before:always}
  }

  /* Compaction éléments pour tenir sur 1 page */
  .kpi-print{display:grid;grid-template-columns:repeat(5,1fr);gap:3mm;margin:2mm 0 4mm;align-items:stretch}
  .tile-print{border:1px solid #e5e7eb;border-radius:10px;padding:5mm;display:flex;flex-direction:column;justify-content:space-between;min-height:36mm}
  .lab-print{font-size:11px;color:#475569}
  .val-print{font-size:17px;font-weight:900;text-align:right;font-variant-numeric:tabular-nums;line-height:1.1}
  table{font-size:12px}
  th,td{padding:4px 6px}
  table, tr, td, th{page-break-inside: avoid}
  .fine{font-size:9px;line-height:1.25;margin-top:4mm}

  /* Bar chart (web & pdf) */
  #bar-wrap svg{width:100%;height:280px;border:1px solid #e5e7eb;border-radius:8px;background:#fff}
  #bar-wrap-print svg{width:100%;height:210mm;border:1px solid #e5e7eb;border-radius:8px;background:#fff}

  /* Couleurs amortissement (écran & impression) */
  .text-green{color:#059669 !important}
  .text-red{color:#b91c1c !important}
  .text-blue{color:#1d4ed8 !important}
</style>
</head>
<body>
<div class="topbar no-print"><div class="topbar-inner"><div class="brand"><h1>Simulateur — PAC géothermique <b>NIBE</b></h1></div></div></div>

<div class="wrap no-print">
  <div class="card wizard-head">
    <div class="step-title" id="step-title">Étape 1 · Type de logement</div>
    <div class="progressbar" aria-hidden="true"><div class="bar" id="bar"></div></div>
    <div class="progress-info" id="progress-info">0%</div>
  </div>

  <form id="wizard" novalidate>
    <!-- 1. TYPE LOGEMENT -->
    <section class="card step active" data-title="Type de logement">
      <h2>Type de logement (logement individuel si maison)</h2>
      <div class="choices">
        <label class="choice"><input type="radio" name="type-log" value="Maison individuelle" checked/><span class="lbl">Maison individuelle <span class="muted">(logement individuel)</span></span></label>
        <label class="choice"><input type="radio" name="type-log" value="Appartement"/><span class="lbl">Appartement</span></label>
      </div>
      <div class="actions"><button type="button" class="btn primary" data-next>Suivant</button></div>
    </section>

    <!-- 2. RÉSIDENCE PRINCIPALE -->
    <section class="card step" data-title="Résidence principale">
      <h2>Résidence principale</h2>
      <div class="choices">
        <label class="choice"><input type="radio" name="res-primary" value="Oui" checked/><span class="lbl">Oui</span></label>
        <label class="choice"><input type="radio" name="res-primary" value="Non"/><span class="lbl">Non</span></label>
      </div>
      <div class="actions"><button type="button" class="btn ghost" data-prev>Précédent</button><button type="button" class="btn primary" data-next>Suivant</button></div>
    </section>

    <!-- 3. HYPOTHÈSES -->
    <section class="card step" data-title="Hypothèses">
      <h2>Hypothèses & critères d’éligibilité</h2>
      <div class="checklist">
        <label class="check"><input id="c1" type="checkbox" checked/><span class="txt">Remplacement d’une chaudière gaz/fioul par PAC géothermique NIBE</span></label>
        <label class="check"><input id="c2" type="checkbox" checked/><span class="txt">Travaux réalisés par une entreprise RGE (PAC géothermique)</span></label>
        <label class="check"><input id="c3" type="checkbox" checked/><span class="txt">Logement de plus de 15 ans</span></label>
        <label class="check"><input id="c4" type="checkbox" checked/><span class="txt">Dossier déposé avant travaux</span></label>
        <label class="check"><input id="c5" type="checkbox" checked/><span class="txt">ETAS &gt; 154 % pour régime d’eau à 55 °C</span></label>
        <label class="check"><input id="c6" type="checkbox" checked/><span class="txt">ETAS &gt; 204 % pour régime d’eau à 35 °C</span></label>
      </div>
      <div class="actions"><button type="button" class="btn ghost" data-prev>Précédent</button><button type="button" class="btn primary" data-next>Suivant</button></div>
    </section>

    <!-- 4. MÉNAGE -->
    <section class="card step" data-title="Ménage">
      <h2>Nombre de personnes dans le ménage</h2>
      <input id="menage-nb" type="number" min="1" step="1" value="2" required/>
      <div class="actions"><button type="button" class="btn ghost" data-prev>Précédent</button><button type="button" class="btn primary" data-next>Suivant</button></div>
    </section>

    <!-- 5. RFR -->
    <section class="card step" data-title="Revenus">
      <h2>Revenu fiscal de référence du foyer (€)</h2>
      <input id="rfr" type="number" min="0" step="0.01" placeholder="Ex. 80231.57" required/>
      <small class="muted">Vous pouvez saisir un montant au centime près.</small>
      <div class="actions"><button type="button" class="btn ghost" data-prev>Précédent</button><button type="button" class="btn primary" data-next>Suivant</button></div>
    </section>

    <!-- 6. RÉGION BARÈME -->
    <section class="card step" data-title="Région">
      <h2>Région de barème</h2>
      <select id="region">
        <option value="hors_idf" selected>Hors Île-de-France</option>
        <option value="idf">Île-de-France</option>
      </select>
      <div class="actions"><button type="button" class="btn ghost" data-prev>Précédent</button><button type="button" class="btn primary" data-next>Suivant</button></div>
    </section>

    <!-- 7. CHOIX SYSTÈME -->
    <section class="card step" data-title="Système">
      <h2>Choix du système</h2>
      <select id="type-pac">
        <option value="sol_eau_vertical" selected>Sol/Eau — sondes verticales (forage)</option>
        <option value="sol_eau_horizontaux">Sol/Eau — capteurs horizontaux</option>
        <option value="eau_eau">Eau/Eau — nappe / aquifère</option>
      </select>
      <small class="muted">Par défaut : capteurs <b>verticaux</b> (sol/eau).</small>
      <div class="actions"><button type="button" class="btn ghost" data-prev>Précédent</button><button type="button" class="btn primary" data-next>Suivant</button></div>
    </section>

    <!-- 8. COÛT PAC NIBE -->
    <section class="card step" data-title="Coûts PAC NIBE">
      <h2>Coûts — PAC NIBE</h2>
      <div class="row">
        <div class="half"><label for="pac-fourn">Fourniture (€)</label><input id="pac-fourn" type="number" min="0" step="0.01" placeholder="Ex. 15000.55"/></div>
        <div class="half"><label for="pac-mdo">Main d’œuvre (€)</label><input id="pac-mdo" type="number" min="0" step="0.01" placeholder="Ex. 2999.99"/></div>
      </div>
      <div class="actions"><button type="button" class="btn ghost" data-prev>Précédent</button><button type="button" class="btn primary" data-next>Suivant</button></div>
    </section>

    <!-- 9. COÛT CAPTAGE -->
    <section class="card step" data-title="Coûts captage">
      <h2>Coûts — Captage</h2>
      <div class="row">
        <div class="half"><label for="capt-fourn">Fourniture (€)</label><input id="capt-fourn" type="number" min="0" step="0.01" placeholder="Ex. 8000.40"/></div>
        <div class="half"><label for="capt-mdo">Pose (€)</label><input id="capt-mdo" type="number" min="0" step="0.01" placeholder="Ex. 3500.75"/></div>
      </div>
      <div class="actions"><button type="button" class="btn ghost" data-prev>Précédent</button><button type="button" class="btn primary" data-next>Suivant</button></div>
    </section>

    <!-- 10. BASE IDENTIQUE -->
    <section class="card step" data-title="Remplacement à l’identique">
      <h2>Si vous remplaciez à l’identique</h2>
      <p class="muted" style="margin-top:-4px">Indiquez le <b>coût total</b> (fourniture + pose) pour une chaudière gaz/fioul équivalente. Nous comparerons à la PAC NIBE pour afficher la <b>plus-value réelle</b>.</p>
      <label for="base-remplacement">Facture totale TTC (€)</label>
      <input id="base-remplacement" type="number" min="0" step="0.01" placeholder="Ex. 6500.00"/>
      <div class="actions"><button type="button" class="btn ghost" data-prev>Précédent</button><button type="button" class="btn primary" id="btn-calc">Voir le résultat</button></div>
    </section>
  </form>

  <!-- Résultat LIVE -->
  <div class="card" id="live" style="display:none">
    <h2>Résultat de simulation (aperçu)</h2>
    <div id="elig-msg" class="warn" style="display:none"></div>
    <div class="kpi" style="margin-top:8px">
      <div class="tile"><div class="lab">Catégorie CEE</div><div class="val" id="k-cat-live">—</div></div>
      <div class="tile"><div class="lab">Total projet TTC</div><div class="val" id="k-total-live">0 €</div></div>
      <div class="tile aides"><div class="lab">Total des aides</div><div class="val" id="k-aides-live">0 €</div></div>
      <div class="tile"><div class="lab">Reste à charge</div><div class="val" id="k-rac-live">0 €</div></div>
      <div class="tile"><div class="lab">Plus-value vs rempla.</div><div class="val pv-green" id="k-plus-live">0 €</div></div>
    </div>
    <div style="overflow:auto;margin-top:8px">
      <table>
        <thead><tr><th>Élément</th><th>Détails</th><th class="right">Montant (€)</th></tr></thead>
        <tbody>
          <tr><td>Coût PAC NIBE</td><td id="r-pac-detail-live">—</td><td class="right" id="r-pac-live">0</td></tr>
          <tr><td>Coût captage</td><td id="r-capt-detail-live">—</td><td class="right" id="r-capt-live">0</td></tr>
          <tr><td><b>Total projet TTC</b></td><td>PAC + captage</td><td class="right" id="r-total-live">0</td></tr>
          <tr><td>MaPrimeRénov’ estimée</td><td id="r-mpr-detail-live">Profil : —</td><td class="right" id="r-mpr-live">0</td></tr>
          <tr><td>Prime CEE estimée</td><td id="r-cee-detail-live">—</td><td class="right" id="r-cee-live">0</td></tr>
          <tr><td><b>Total aides</b></td><td>MPR + CEE</td><td class="right" id="r-aides-live">0</td></tr>
          <tr><td><b>Reste à charge</b></td><td>Total projet − Total aides</td><td class="right" id="r-rac2-live"><b>0</b></td></tr>
          <tr><td>Coût « rempla. à l’identique »</td><td>Chaudière gaz/fioul</td><td class="right" id="r-base-live">0</td></tr>
          <tr><td><b>Plus-value vs remplacement</b></td><td>Reste à charge − Coût remplacement</td><td class="right pv-green" id="r-plusvalue-live">0</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Amortissement -->
  <div class="card" id="amort" style="display:none">
    <h2>Amortissement (option)</h2>
    <p class="muted">Calcule la <b>durée d’amortissement</b> à partir de la <b>plus-value vs remplacement</b> et des <b>économies annuelles</b>.</p>

    <div class="row">
      <div class="half">
        <label for="amort-mode">Énergie actuelle</label>
        <select id="amort-mode">
          <option value="fioul" selected>Fioul</option>
          <option value="gaz">Gaz naturel</option>
          <option value="propane">Propane</option>
        </select>
      </div>
    </div>

    <!-- Fioul -->
    <div id="bloc-fioul" class="row" style="margin-top:10px">
      <div class="half"><label for="fioul-litres">Consommation fioul (L/an)</label><input id="fioul-litres" type="number" min="0" step="1" placeholder="Ex. 2000"/></div>
      <div class="half"><label for="fioul-prix">Prix du litre de fioul (€)</label><input id="fioul-prix" type="number" min="0" step="0.001" placeholder="Ex. 1.60"/></div>
      <div class="half"><label for="elec-prix-fioul">Prix du kWh électrique (€)</label><input id="elec-prix-fioul" type="number" min="0" step="0.001" placeholder="Ex. 0.22"/></div>
    </div>

    <!-- Gaz -->
    <div id="bloc-gaz" class="row" style="display:none;margin-top:10px">
      <div class="half"><label for="gaz-kwh">Conso gaz (kWh/an)</label><input id="gaz-kwh" type="number" min="0" step="1" placeholder="Ex. 20000"/></div>
      <div class="half"><label for="gaz-prix">Prix du kWh gaz (€)</label><input id="gaz-prix" type="number" min="0" step="0.001" placeholder="Ex. 0.10"/></div>
      <div class="half"><label for="gaz-abo">Abonnement gaz (€ / an)</label><input id="gaz-abo" type="number" min="0" step="0.01" placeholder="Ex. 250"/></div>
      <div class="half"><label for="elec-prix-gaz">Prix du kWh électrique (€)</label><input id="elec-prix-gaz" type="number" min="0" step="0.001" placeholder="Ex. 0.22"/></div>
    </div>

    <!-- Propane -->
    <div id="bloc-propane" class="row" style="display:none;margin-top:10px">
      <div class="half"><label for="prop-tonnes">Tonnes de propane (t/an)</label><input id="prop-tonnes" type="number" min="0" step="0.01" placeholder="Ex. 1.2"/></div>
      <div class="half"><label for="prop-prix-tonne">Prix de la tonne (€)</label><input id="prop-prix-tonne" type="number" min="0" step="0.01" placeholder="Ex. 2800"/></div>
      <div class="half"><label for="prop-abo">Abonnement cuve (€ / an)</label><input id="prop-abo" type="number" min="0" step="0.01" placeholder="Ex. 150"/></div>
      <div class="half"><label for="elec-prix-prop">Prix du kWh électrique (€)</label><input id="elec-prix-prop" type="number" min="0" step="0.001" placeholder="Ex. 0.22"/></div>
    </div>

    <div class="actions" style="margin-top:10px"><button type="button" class="btn" id="btn-amort-calc">Calculer</button></div>

    <div id="amort-result" style="display:none;margin-top:10px">
      <div class="kpi">
        <div class="tile"><div class="lab">Énergie thermique</div><div class="val" id="amort-therm-kwh">0 kWh/an</div></div>
        <div class="tile"><div class="lab">Conso électrique PAC</div><div class="val" id="amort-pac-kwh">0 kWh/an</div></div>
        <div class="tile"><div class="lab">Coût énergie actuel</div><div class="val text-red" id="amort-actuel">0 €</div></div>
        <div class="tile"><div class="lab">Coût PAC (élec)</div><div class="val text-green" id="amort-pac-eur">0 €</div></div>
        <div class="tile"><div class="lab">Économies/an</div><div class="val text-green" id="amort-eco">0 €</div></div>
        <div class="tile"><div class="lab">Plus-value vs remplacement</div><div class="val" id="amort-plus">0 €</div></div>
        <div class="tile"><div class="lab">Amortissement</div><div class="val text-green" id="amort-years">—</div></div>
      </div>

      <!-- Graphique colonnes – web -->
      <div id="bar-wrap"><svg id="bar-svg" viewBox="0 0 800 280" preserveAspectRatio="none"></svg></div>
    </div>
  </div>

  <!-- Actions rapport -->
  <div class="card" id="resultat" style="display:none">
    <h2>Rapport</h2>
    <div class="row" style="align-items:center;gap:12px">
      <button class="btn" id="btn-preview">Voir le rapport</button>
      <button class="btn primary" id="btn-print">Imprimer / Export PDF (A4)</button>
      <span class="muted">PDF : Page 1 = rapport + mentions · Page 2 = graphique (si amortissement calculé).</span>
    </div>
  </div>
</div>

<!-- RAPPORT A4 -->
<section id="rapport-letter">
  <!-- PAGE 1 -->
  <div class="a4" id="page1">
    <h2 style="text-align:center;margin:0 0 2mm;font-size:18px">Résultat de simulation — PAC géothermique NIBE</h2>

    <div class="kpi-print">
      <div class="tile-print"><div class="lab-print">Catégorie CEE</div><div class="val-print" id="k-cat">—</div></div>
      <div class="tile-print"><div class="lab-print">Total projet TTC</div><div class="val-print" id="k-total">0 €</div></div>
      <div class="tile-print" style="background:#eef2ff;border-color:#c7d2fe"><div class="lab-print">Total des aides (MPR + CEE)</div><div class="val-print" id="k-aides" style="color:#1d4ed8">0 €</div></div>
      <div class="tile-print"><div class="lab-print">Reste à charge</div><div class="val-print" id="k-rac">0 €</div></div>
      <div class="tile-print"><div class="lab-print">Plus-value vs remplacement</div><div class="val-print" id="k-plus" style="color:#059669">0 €</div></div>
    </div>

    <table>
      <thead><tr><th>Élément</th><th>Détails</th><th class="right">Montant (€)</th></tr></thead>
      <tbody>
        <tr><td>Coût PAC NIBE (fourniture + pose)</td><td id="r-pac-detail">—</td><td class="right" id="r-pac">0</td></tr>
        <tr><td>Coût captage (selon type)</td><td id="r-capt-detail">—</td><td class="right" id="r-capt">0</td></tr>
        <tr><td><b>Total projet TTC</b></td><td>PAC + captage</td><td class="right" id="r-total">0</td></tr>
        <tr><td>MaPrimeRénov’ estimée</td><td id="r-mpr-detail">Profil : —</td><td class="right" id="r-mpr">0</td></tr>
        <tr><td>Prime CEE estimée</td><td id="r-cee-detail">—</td><td class="right" id="r-cee">0</td></tr>
        <tr><td><b>Total des aides estimées</b></td><td>MPR + CEE</td><td class="right" id="r-aides">0</td></tr>
        <tr><td><b>Reste à charge</b></td><td>Total projet − Total aides</td><td class="right" id="r-rac2"><b>0</b></td></tr>
        <tr><td>Coût « remplacement à l’identique »</td><td>Chaudière gaz/fioul</td><td class="right" id="r-base">0</td></tr>
        <tr><td><b>Plus-value vs remplacement</b></td><td>Reste à charge − Coût remplacement</td><td class="right" id="r-plusvalue" style="color:#059669">0</td></tr>
      </tbody>
    </table>

    <!-- Section Amortissement (ajout si saisi) -->
    <div id="amort-print" style="display:none">
      <h3 style="margin-top:6mm">Amortissement (option)</h3>
      <table>
        <tbody>
          <tr><td>Énergie thermique</td><td class="right" id="p-therm-kwh">0 kWh/an</td></tr>
          <tr><td>Coût énergie actuel</td><td class="right text-red" id="p-actuel">0 €</td></tr>
          <tr><td>Coût PAC (élec)</td><td class="right text-green" id="p-pac-eur">0 €</td></tr>
          <tr><td>Économies / an</td><td class="right text-green" id="p-eco">0 €</td></tr>
          <tr><td>Plus-value vs remplacement</td><td class="right" id="p-plus">0 €</td></tr>
          <tr><td>Amortissement</td><td class="right text-green" id="p-years">—</td></tr>
        </tbody>
      </table>
    </div>

    <div class="fine">
      <p><b>Mentions :</b> Estimation <b>non engageante</b>. Calculs basés sur les <b>données déclarées</b> (coûts, revenus, composition du ménage, choix techniques) et des <b>hypothèses indicatives</b> (prix d’énergie, performances, barèmes). Les montants définitifs sont conditionnés aux justificatifs, critères techniques, contrôles et validations (ANAH pour MaPrimeRénov’, délégataire CEE). Le « bonus de la Prime énergie d’EDF » est intégré selon la <b>catégorie CEE</b>. Dossiers à déposer <b>avant travaux</b>. Période ciblée : <b>01/09/2025 → 31/12/2025</b>. Monogeste : remplacement chaudière gaz/fioul par PAC géothermique NIBE. Les tarifs d’énergie saisis priment ; à défaut, références possibles (gaz 0,1284 €/kWh, fioul 1,16 €/L, propane ≈ 0,243 €/kWh).</p>
    </div>
  </div>

  <!-- PAGE 2 : Graphique coûts annuels -->
  <div class="a4 page-break" id="chart-page" style="display:none">
    <h2 style="text-align:center;margin:0 0 6mm">Comparaison des coûts annuels d’énergie (€)</h2>
    <div id="bar-wrap-print">
      <svg id="bar-svg-print" viewBox="0 0 800 800" preserveAspectRatio="none"></svg>
    </div>
    <div class="fine">
      <p>Légende : Géothermie (vert), Gaz naturel (orange), Propane (rouge), Fioul (noir). Les coûts affichés sont annuels et fondés sur les données et hypothèses du dossier (voir page 1).</p>
    </div>
  </div>
</section>

<script>
  /* Barèmes indicatifs MPR / CEE (peuvent être mis à jour) */
  const thresholds={hors_idf:{1:{tm:16000,mo:20593,int:29148},2:{tm:23655,mo:30225,int:42848},3:{tm:28400,mo:36297,int:51293},4:{tm:33145,mo:42371,int:59738},5:{tm:37899,mo:48454,int:68181}},
                    idf:{1:{tm:21411,mo:27656,int:38184},2:{tm:31441,mo:40544,int:56238},3:{tm:37793,mo:48731,int:67673},4:{tm:44145,mo:56927,int:79110},5:{tm:50497,mo:65123,int:90547}}};
  const thresholdsCEE={idf:{1:{tm:23768,mo:28933},2:{tm:34884,mo:42463},3:{tm:41893,mo:51000},4:{tm:48914,mo:59549},5:{tm:55961,mo:68123},plus:{tm:7038,mo:8568}},
                       hors_idf:{1:{tm:17173,mo:22015},2:{tm:25115,mo:32197},3:{tm:30206,mo:38719},4:{tm:35285,mo:45234},5:{tm:40388,mo:51775},plus:{tm:5094,mo:6525}}};

  const $=id=>document.getElementById(id);
  const val=id=>($(id)?.value||'').trim();
  const num=id=>{const n=parseFloat((val(id)||'0').replace(/[^0-9.-]/g,''));return isNaN(n)?0:n};
  const euro=n=>new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR',maximumFractionDigits:0}).format(n||0);
  const euro2=n=>new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR',maximumFractionDigits:2}).format(n||0);
  const fmt=n=>new Intl.NumberFormat('fr-FR',{maximumFractionDigits:0}).format(n||0);

  /* Profils MPR & CEE */
  function autoProfil(region,taille,rfr){
    const row=(thresholds[region]||{})[Math.min(5,Math.max(1,taille))];
    if(!row){return{profil:'intermediaires',via:'barèmes à confirmer'}}
    if(rfr<=row.tm)return{profil:'tres_modestes',via:`≤ TM (${row.tm})`};
    if(rfr<=row.mo)return{profil:'modestes',via:`≤ MO (${row.mo})`};
    if(rfr<=row.int)return{profil:'intermediaires',via:`≤ INT (${row.int})`};
    return{profil:'superieurs',via:`> INT (${row.int})`};
  }
  function getProfilMPR(){const rfr=num('rfr');const taille=Math.max(1,parseInt(val('menage-nb')||'1',10));const region=val('region');return autoProfil(region,taille,rfr);}
  function getCEECategorie(){
    const region=val('region');const taille=Math.max(1,parseInt(val('menage-nb')||'1',10));const rfr=num('rfr');
    const tab=thresholdsCEE[region];const base=tab[Math.min(5,taille)];const extra=Math.max(0,taille-5);
    const tm=base.tm+extra*(tab.plus.tm);const mo=base.mo+extra*(tab.plus.mo);
    if(rfr<=tm) return 'très modeste';
    if(rfr<=mo) return 'modeste';
    const row=(thresholds[region]||{})[Math.min(5,taille)];
    if(row && rfr<=row.int) return 'revenu intermédiaire';
    return 'revenu supérieur';
  }
  function calcCEE(){return (getCEECategorie()==='très modeste')?6000:5150}
  function getMPRAmount(){const {profil}=getProfilMPR();const map={tres_modestes:11000,modestes:9000,intermediaires:6000,superieurs:0};return map[profil]??0}

  /* Éligibilité (inclut ETAS) */
  function checkEligibility(){
    const isAppartement=document.querySelector('input[name="type-log"][value="Appartement"]').checked;
    const isResidencePrincipale=document.querySelector('input[name="res-primary"]:checked')?.value==='Oui';
    const c1=$('c1').checked,c2=$('c2').checked,c3=$('c3').checked,c4=$('c4').checked,c5=$('c5').checked,c6=$('c6').checked;
    const issues=[];
    if(isAppartement)issues.push("Type de logement : appartement (non éligible en monogeste géothermie standard).");
    if(!isResidencePrincipale)issues.push("Résidence non principale : non éligible MPR/CEE.");
    if(!c1)issues.push("Le geste doit être le remplacement chaudière par PAC géothermique NIBE.");
    if(!c2)issues.push("Entreprise non RGE : condition indispensable.");
    if(!c3)issues.push("Logement de moins de 15 ans : non éligible.");
    if(!c4)issues.push("Dossier non déposé avant travaux : non éligible.");
    if(!c5)issues.push("ETAS ≤ 154 % à 55 °C : non éligible.");
    if(!c6)issues.push("ETAS ≤ 204 % à 35 °C : non éligible.");
    return {eligible:issues.length===0,issues};
  }

  let LAST_RAC=0, LAST_PLUS=0, AMORT=null;

  function remplir(target){
    const pac=num('pac-fourn')+num('pac-mdo');
    const capt=num('capt-fourn')+num('capt-mdo');
    const total=pac+capt;

    const elig=checkEligibility();
    let mpr=0, cee=0, totalAides=0, catCEE='—', profilTxt='—', via='—';
    if(elig.eligible){
      mpr=getMPRAmount(); cee=calcCEE(); totalAides=mpr+cee; catCEE=getCEECategorie();
      const p=getProfilMPR(); profilTxt=p.profil.replace('_',' '); via=p.via;
    }

    const base=num('base-remplacement');
    const rac=Math.max(0,total-totalAides); LAST_RAC=rac;
    const plus=rac-base; LAST_PLUS=plus;

    if(target==='live'){
      const typeTxt=$('type-pac').selectedOptions[0].text;
      $('r-pac-detail-live').textContent=`Fourniture ${euro(num('pac-fourn'))} + MO ${euro(num('pac-mdo'))}`;
      $('r-capt-detail-live').textContent=`${typeTxt} — Fourniture ${euro(num('capt-fourn'))} + Pose ${euro(num('capt-mdo'))}`;
      $('r-pac-live').textContent=euro(pac); $('r-capt-live').textContent=euro(capt); $('r-total-live').textContent=euro(total);
      $('r-mpr-detail-live').textContent=`Profil : ${profilTxt} (${via})`; $('r-mpr-live').textContent=euro(mpr);
      $('r-cee-detail-live').textContent=elig.eligible?`bonus Prime énergie EDF (catégorie ${catCEE})`:'Non éligible'; $('r-cee-live').textContent=euro(cee);
      $('r-aides-live').textContent=euro(totalAides); $('r-rac2-live').innerHTML='<b>'+euro(rac)+'</b>'; $('r-base-live').textContent=euro(base); $('r-plusvalue-live').textContent=euro(plus);
      $('k-cat-live').textContent=catCEE; $('k-total-live').textContent=euro(total); $('k-aides-live').textContent=euro(totalAides); $('k-rac-live').textContent=euro(rac); $('k-plus-live').textContent=euro(plus);
      const warn=$('elig-msg'); if(elig.issues.length){warn.style.display='block';warn.innerHTML='<b>Non éligible :</b><br>'+elig.issues.map(s=>'• '+s).join('<br>');}else{warn.style.display='none';warn.textContent='';}
    }

    if(target==='print'){
      $('r-pac-detail').textContent=`Fourniture ${euro(num('pac-fourn'))} + MO ${euro(num('pac-mdo'))}`;
      $('r-capt-detail').textContent=`${$('type-pac').selectedOptions[0].text} — Fourniture ${euro(num('capt-fourn'))} + Pose ${euro(num('capt-mdo'))}`;
      $('r-pac').textContent=euro(pac); $('r-capt').textContent=euro(capt); $('r-total').textContent=euro(total);
      $('r-mpr-detail').textContent=`Profil : ${profilTxt} (${via})`; $('r-mpr').textContent=euro(mpr);
      $('r-cee-detail').textContent=elig.eligible?`bonus Prime énergie EDF (catégorie ${catCEE})`:'Non éligible'; $('r-cee').textContent=euro(cee);
      $('r-aides').textContent=euro(totalAides); $('r-rac2').innerHTML='<b>'+euro(rac)+'</b>'; $('r-base').textContent=euro(base); $('r-plusvalue').textContent=euro(plus);
      $('k-cat').textContent=catCEE; $('k-total').textContent=euro(total); $('k-aides').textContent=euro(totalAides); $('k-rac').textContent=euro(rac); $('k-plus').textContent=euro(plus);

      if(AMORT){
        $('amort-print').style.display='block';
        $('p-therm-kwh').textContent = fmt(AMORT.thermKwh) + ' kWh/an';
        $('p-actuel').textContent    = euro2(AMORT.costNow);
        $('p-pac-eur').textContent   = euro2(AMORT.pacCost);
        $('p-eco').textContent       = euro2(AMORT.savingsYear);
        $('p-plus').textContent      = euro2(LAST_PLUS);
        $('p-years').textContent     = AMORT.yearsText;

        // page 2 visible
        $('chart-page').style.display='block';
        drawBarChart('bar-svg-print', AMORT.bars, true);
      } else {
        $('amort-print').style.display='none';
        $('chart-page').style.display='none';
      }
    }
  }

  /* Wizard nav */
  const steps=[...document.querySelectorAll('.step')]; let idx=0; const bar=$('bar'),info=$('progress-info'),title=$('step-title');
  const TITLES=steps.map(s=>s.getAttribute('data-title')); const percent=()=>Math.round(((idx+1)/steps.length)*100);
  function updateHead(){bar.style.width=percent()+"%";info.textContent=percent()+"%";title.textContent=`Étape ${idx+1} · ${TITLES[idx]}`;}
  function show(i){steps[idx].classList.remove('active');idx=i;steps[idx].classList.add('active');updateHead();window.scrollTo({top:0,behavior:'smooth'})}
  function validateStep(){const cur=steps[idx];const invalid=cur.querySelector(':invalid');if(invalid){invalid.reportValidity();return false}return true}
  document.addEventListener('click',e=>{ if(e.target.matches('[data-next]')){ if(validateStep()) show(Math.min(idx+1,steps.length-1)); } if(e.target.matches('[data-prev]')){ show(Math.max(idx-1,0)); }});
  updateHead();

  // Voir résultat
  $('btn-calc')?.addEventListener('click',()=>{
    const required=['menage-nb','rfr'];
    for(const id of required){const el=$(id); if(el && !el.checkValidity()){el.reportValidity(); return;}}
    $('live').style.display='block'; remplir('live');
    $('resultat').style.display='block'; $('amort').style.display='block';
    window.scrollTo({top:$('live').offsetTop-8,behavior:'smooth'});
  });

  // Aperçu rapport (affiche le bloc A4 dans la page)
  $('btn-preview')?.addEventListener('click',()=>{
    remplir('print');
    const rep=$('rapport-letter');
    rep.style.display='block';
    window.scrollTo({top:rep.offsetTop-8,behavior:'smooth'});
  });

  // Impression robuste
  $('btn-print')?.addEventListener('click',()=>{
    remplir('print');
    const rep=$('rapport-letter');
    const wasHidden = getComputedStyle(rep).display==='none';
    rep.style.display='block';
    setTimeout(()=>{
      window.print();
      setTimeout(()=>{ if(wasHidden){rep.style.display='none';} }, 300);
    }, 150);
  });

  /* ===== Amortissement ===== */
  const COP_GEO=5.5;          // interne (non affiché)
  const KWH_PER_LITRE=10;

  const PRICE_GAZ_REF = 0.1284;      // €/kWh (extrapolation si non saisi)
  const PRICE_PROPANE = 2800/11520;  // ≈ 0.2431 €/kWh
  const PRICE_FIOUL_KWH = 1.16/10;   // 0.116 €/kWh

  $('amort-mode')?.addEventListener('change',()=>{
    const m=val('amort-mode');
    ['fioul','gaz','propane'].forEach(k=>{$('bloc-'+k).style.display=(m===k)?'flex':'none';});
  });

  function drawBarChart(svgId, bars, big=false){
    const svg=$(svgId); if(!svg) return;
    const W=800, H=big?800:280, PX=70, PY=40;
    const labels=['Géothermie','Gaz naturel','Propane','Fioul'];
    const colors=['#059669','#f59e0b','#dc2626','#111827'];
    const vals=[bars.geo,bars.gaz,bars.propane,bars.fioul].map(v=>Math.max(0,v||0));
    const max=Math.max(...vals,1);
    const colSpace=(W-PX-20)/labels.length;
    const bw=colSpace*0.55;

    svg.innerHTML='';
    // axes
    svg.innerHTML += `<line x1="${PX}" y1="${H-PY}" x2="${W-10}" y2="${H-PY}" stroke="#94a3b8" stroke-width="1"/>`;
    svg.innerHTML += `<line x1="${PX}" y1="${PY}" x2="${PX}" y2="${H-PY}" stroke="#94a3b8" stroke-width="1"/>`;

    // y ticks
    const levels=6;
    for(let i=0;i<=levels;i++){
      const y=H-PY - (H-PY-PY)*(i/levels);
      const v=Math.round(max*(i/levels));
      svg.innerHTML += `<line x1="${PX}" y1="${y}" x2="${W-10}" y2="${y}" stroke="#e5e7eb" stroke-width="1"/>`;
      svg.innerHTML += `<text x="${PX-8}" y="${y+4}" font-size="${big?18:11}" text-anchor="end" fill="#475569">${new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR',maximumFractionDigits:0}).format(v)}</text>`;
    }

    // bars
    labels.forEach((lab,i)=>{
      const v=vals[i];
      const x=PX+10 + i*((W-PX-20)/labels.length);
      const h=(H-PY-PY)*(v/max);
      const y=H-PY - h;
      svg.innerHTML += `<rect x="${x}" y="${y}" width="${bw}" height="${h}" fill="${colors[i]}"/>`;
      svg.innerHTML += `<text x="${x+bw/2}" y="${H-PY+16}" font-size="${big?22:12}" text-anchor="middle" fill="#334155">${lab}</text>`;
      svg.innerHTML += `<text x="${x+bw/2}" y="${y-8}" font-size="${big?22:12}" text-anchor="middle" fill="#0f172a">${new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR',maximumFractionDigits:0}).format(v)}</text>`;
    });
  }

  $('btn-amort-calc')?.addEventListener('click',()=>{
    const mode = val('amort-mode');
    let thermKwh=0, pacKwh=0, costNow=0, pacCost=0, elecPrice=0;

    if(mode==='fioul'){
      const litres = num('fioul-litres');
      const prixL  = num('fioul-prix');
      elecPrice    = num('elec-prix-fioul');
      thermKwh = litres * KWH_PER_LITRE;
      costNow  = litres * prixL;
      pacKwh   = thermKwh / COP_GEO;
      pacCost  = pacKwh * elecPrice;
    } else if(mode==='gaz'){
      const gazK   = num('gaz-kwh');
      const prixG  = num('gaz-prix');
      const aboG   = num('gaz-abo');
      elecPrice    = num('elec-prix-gaz');
      thermKwh = gazK;
      costNow  = gazK * prixG + aboG;
      pacKwh   = thermKwh / COP_GEO;
      pacCost  = pacKwh * elecPrice;
    } else if(mode==='propane'){
      const t      = num('prop-tonnes');
      const prixT  = num('prop-prix-tonne');
      const aboP   = num('prop-abo');
      elecPrice    = num('elec-prix-prop');
      const kwh    = t * 11520;
      thermKwh     = kwh;
      costNow      = (prixT>0 ? t*prixT : kwh*PRICE_PROPANE) + aboP;
      pacKwh       = thermKwh / COP_GEO;
      pacCost      = pacKwh * elecPrice;
    }

    const savingsYear = costNow - pacCost;                // Économies annuelles €
    const plusValue   = (LAST_RAC || 0) - num('base-remplacement'); // plus-value vs remplacement
    let yearsText = '—';
    if(savingsYear > 0){
      const years = plusValue / savingsYear;
      yearsText = (isFinite(years)) ? years.toFixed(1)+' ans' : '—';
    } else yearsText='non calculable';

    // UI live amortissement
    $('amort-therm-kwh').textContent = fmt(thermKwh) + ' kWh/an';
    $('amort-pac-kwh').textContent   = fmt(pacKwh)   + ' kWh/an';
    $('amort-actuel').textContent    = euro2(costNow);
    $('amort-pac-eur').textContent   = euro2(pacCost);
    $('amort-eco').textContent       = euro2(savingsYear);
    $('amort-plus').textContent      = euro2(plusValue);
    $('amort-years').textContent     = yearsText;
    $('amort-result').style.display  = 'block';

    // Coûts annuels pour le graphique (€/an)
    const costGeo  = pacCost;
    const costGaz  = (mode==='gaz') ? costNow : (thermKwh * PRICE_GAZ_REF);
    const costProp = (mode==='propane') ? costNow : (thermKwh * PRICE_PROPANE);
    const costFioul= (mode==='fioul') ? costNow : (thermKwh * PRICE_FIOUL_KWH);

    drawBarChart('bar-svg',        {geo:costGeo, gaz:costGaz, propane:costProp, fioul:costFioul}, false);
    AMORT = {mode, thermKwh, pacKwh, costNow, pacCost, savingsYear, yearsText,
             bars:{geo:costGeo, gaz:costGaz, propane:costProp, fioul:costFioul}};
  });
</script>
</body>
</html>
